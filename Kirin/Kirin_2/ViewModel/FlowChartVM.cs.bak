using Kirin_2.Models;
using Kirin_2.ViewModel.Command;
using Syncfusion.UI.Xaml.Diagram;
using Syncfusion.UI.Xaml.Diagram.Controls;
using Syncfusion.UI.Xaml.Diagram.Layout;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;

namespace Kirin_2.ViewModel
{
    public class FlowChartVM : DiagramViewModel
    {
        KIRINEntities1 kirinentities;
        
        #region Constructor
        public FlowChartVM()
        {

            //This command will get invoked when an item is added to the diagram.
            ItemAddedCommand = new CommandFlow(args => OnItemAdded((ItemAddedEventArgs)args));

            // Initialize Gridlines for SfDiagram
            SnapSettings = new SnapSettings()
            {
                SnapToObject = SnapToObject.All,
                SnapConstraints = SnapConstraints.None,

            }; 


            //Initialize Context menu for diagram.
            Menu = null;
            DefaultConnectorType = ConnectorType.CubicBezier;

            // Initialize DataSourceSettings for SfDiagram
            DataSourceSettings = new FlowchartDataSourceSettings()
            {
                ParentId = "ParentId",
                Id = "Id",
                DataSource = GetData(),
                ConnectorTextMapping = "Label",

                ShapeMapping = "_Shape",
                WidthMapping = "_Width",
                HeightMapping = "_Height"
            };

            // Initialize LayoutSettings for SfDiagram
            LayoutManager = new LayoutManager()
            {
                Layout = new MindMapTreeLayout()
                {
                    Orientation = Orientation.Horizontal,

                    HorizontalSpacing = 200,
                    VerticalSpacing = 70,
                },

                //Layout = new FlowchartLayout()
                //{
                //    Orientation = FlowchartOrientation.TopToBottom,

                //    HorizontalSpacing = 70,
                //    VerticalSpacing = 90,
                //},
            };
        }

        private void OnItemAdded(ItemAddedEventArgs args)
        {
            if (args.Item is ConnectorViewModel)
            {
                var connectorannotations = (args.Item as ConnectorViewModel).Annotations as AnnotationCollection;
                foreach (AnnotationEditorViewModel anno in connectorannotations)
                {
                    //anno.Alignment = ConnectorAnnotationAlignment.Center;
                    anno.Length = 0.6;
                    //anno.Displacement = 0;
                }
            }
            else if (args.Item is NodeViewModel)
            {
                var nodeannotations = (args.Item as NodeViewModel).Annotations as AnnotationCollection;
                
                foreach (AnnotationEditorViewModel anno in nodeannotations)
                {
                    anno.TextHorizontalAlignment = TextAlignment.Center;
                }
            }
        }


        #endregion

        /// <summary>
        /// Method to Get Data for DataSource
        /// </summary>
        /// <param name="data"></param>
        private DataItems GetData()
        {
            kirinentities = new KIRINEntities1();
            var staffData = kirinentities.GetShortBudgetData().ToList();

            DataItems ItemsInfo = new DataItems();

            foreach (GetShortBudgetData_Result item in staffData)
            {
                ItemsInfo.Add(new ItemInfo()
                {
                    Id = item.ID.ToString(),
                    Label = new List<string> { item.BUDGET + "$" },
                    Name = item.BUDGET_LABEL,
                    ParentId = new List<string> { item.PARENTID.ToString() },
                    _Shape = App.Current.Resources["OnPageReference"] as string,
                    _Width = Convert.ToDouble(item.WIDTH),
                    _Height = Convert.ToDouble(item.HEIGHT),
                    _Color = item.COLOR,
                    IsRoot = Convert.ToBoolean(item.ISHEADER),
                    Level = Convert.ToInt32(item.LEVEL_NUMBER)
                });
            }

            return ItemsInfo;
        }
    }
}
